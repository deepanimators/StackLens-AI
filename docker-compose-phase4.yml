version: '3.8'\n\nservices:\n  # Analytics Service - Phase 4 Real-Time Analytics\n  analytics-service:\n    build:\n      context: .\n      dockerfile: infrastructure/docker/analytics.Dockerfile\n    container_name: stacklens-analytics-service\n    depends_on:\n      - kafka\n      - postgres\n    environment:\n      # Kafka Configuration\n      KAFKA_BOOTSTRAP_SERVERS: kafka:9092\n      KAFKA_INPUT_TOPIC: stacklens-analytics\n      KAFKA_OUTPUT_TOPIC: analytics-alerts\n      KAFKA_CONSUMER_GROUP: analytics-service-group\n      KAFKA_BATCH_SIZE: '100'\n      KAFKA_BATCH_TIMEOUT_MS: '10000'\n      \n      # Database Configuration\n      DB_HOST: postgres\n      DB_PORT: '5432'\n      DB_NAME: stacklens\n      DB_USER: stacklens_user\n      DB_PASSWORD: stacklens_password\n      DB_POOL_MIN: '2'\n      DB_POOL_MAX: '10'\n      \n      # Aggregation Configuration\n      AGGREGATION_WINDOWS: 1min,5min,1hour\n      \n      # Retention Policies (days)\n      RETENTION_HOT: '1'\n      RETENTION_WARM: '7'\n      RETENTION_COLD: '30'\n      \n      # Logging Configuration\n      LOG_LEVEL: INFO\n      LOG_FORMAT: json\n      \n      # Performance Configuration\n      MAX_THREADS: '4'\n      STATS_INTERVAL_SEC: '30'\n      \n      # Monitoring\n      ENABLE_METRICS: 'true'\n      METRICS_PORT: '8004'\n    \n    ports:\n      - \"8004:8004\"  # Metrics port\n    \n    volumes:\n      - ./python-services/analytics_service.py:/app/analytics_service.py:ro\n      - ./python-services/analytics_schema.sql:/app/analytics_schema.sql:ro\n      - ./logs/analytics:/app/logs\n    \n    networks:\n      - stacklens-network\n    \n    restart: on-failure\n    healthcheck:\n      test: [\"CMD\", \"curl\", \"-f\", \"http://localhost:8004/health\"]\n      interval: 30s\n      timeout: 10s\n      retries: 3\n      start_period: 40s\n    \n    # Resource limits\n    deploy:\n      resources:\n        limits:\n          cpus: '2'\n          memory: 1G\n        reservations:\n          cpus: '1'\n          memory: 512M\n\n  # Dashboard API Service - REST API for analytics data\n  dashboard-api:\n    build:\n      context: .\n      dockerfile: infrastructure/docker/dashboard.Dockerfile\n    container_name: stacklens-dashboard-api\n    depends_on:\n      - postgres\n    environment:\n      # Database Configuration\n      DB_HOST: postgres\n      DB_PORT: '5432'\n      DB_NAME: stacklens\n      DB_USER: stacklens_user\n      DB_PASSWORD: stacklens_password\n      \n      # API Configuration\n      API_HOST: '0.0.0.0'\n      API_PORT: '8005'\n      \n      # Logging\n      LOG_LEVEL: INFO\n    \n    ports:\n      - \"8005:8005\"  # Dashboard API port\n    \n    volumes:\n      - ./python-services/dashboard_api.py:/app/dashboard_api.py:ro\n      - ./logs/dashboard:/app/logs\n    \n    networks:\n      - stacklens-network\n    \n    restart: on-failure\n    healthcheck:\n      test: [\"CMD\", \"curl\", \"-f\", \"http://localhost:8005/health\"]\n      interval: 20s\n      timeout: 10s\n      retries: 3\n      start_period: 30s\n    \n    deploy:\n      resources:\n        limits:\n          cpus: '1'\n          memory: 512M\n        reservations:\n          cpus: '0.5'\n          memory: 256M\n\n  # PostgreSQL with TimescaleDB - Time-series optimized database\n  postgres:\n    image: timescale/timescaledb:latest-pg15\n    container_name: stacklens-postgres-analytics\n    environment:\n      POSTGRES_DB: stacklens\n      POSTGRES_USER: stacklens_user\n      POSTGRES_PASSWORD: stacklens_password\n      POSTGRES_INITDB_ARGS: \"-c max_connections=300 -c shared_buffers=512MB -c effective_cache_size=2GB\"\n    \n    ports:\n      - \"5432:5432\"\n    \n    volumes:\n      - postgres-analytics-data:/var/lib/postgresql/data\n      - ./python-services/analytics_schema.sql:/docker-entrypoint-initdb.d/02_analytics_schema.sql:ro\n    \n    networks:\n      - stacklens-network\n    \n    restart: on-failure\n    healthcheck:\n      test: [\"CMD-SHELL\", \"pg_isready -U stacklens_user\"]\n      interval: 10s\n      timeout: 5s\n      retries: 5\n    \n    deploy:\n      resources:\n        limits:\n          cpus: '2'\n          memory: 1G\n        reservations:\n          cpus: '1'\n          memory: 512M\n\n  # Kafka - Message Broker (reused from Phase 3)\n  kafka:\n    image: confluentinc/cp-kafka:7.5.0\n    container_name: stacklens-kafka-analytics\n    depends_on:\n      - zookeeper\n    environment:\n      KAFKA_BROKER_ID: 1\n      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181\n      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092\n      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1\n      KAFKA_AUTO_CREATE_TOPICS_ENABLE: 'true'\n      KAFKA_LOG_RETENTION_HOURS: 168  # 1 week\n      KAFKA_NUM_PARTITIONS: 3\n    \n    ports:\n      - \"9092:9092\"\n    \n    volumes:\n      - kafka-analytics-data:/var/lib/kafka/data\n    \n    networks:\n      - stacklens-network\n    \n    restart: on-failure\n    healthcheck:\n      test: [\"CMD-SHELL\", \"kafka-broker-api-versions --bootstrap-server=localhost:9092\"]\n      interval: 10s\n      timeout: 5s\n      retries: 5\n\n  # Zookeeper - Kafka Coordinator\n  zookeeper:\n    image: confluentinc/cp-zookeeper:7.5.0\n    container_name: stacklens-zookeeper-analytics\n    environment:\n      ZOOKEEPER_CLIENT_PORT: 2181\n      ZOOKEEPER_SYNC_LIMIT: 2\n      ZOOKEEPER_INIT_LIMIT: 5\n    \n    ports:\n      - \"2181:2181\"\n    \n    volumes:\n      - zookeeper-analytics-data:/var/lib/zookeeper/data\n    \n    networks:\n      - stacklens-network\n    \n    restart: on-failure\n\n  # Kafka UI - Monitoring (reused from Phase 3)\n  kafka-ui:\n    image: provectuslabs/kafka-ui:latest\n    container_name: stacklens-kafka-ui-analytics\n    depends_on:\n      - kafka\n    environment:\n      KAFKA_CLUSTERS_0_NAME: stacklens\n      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092\n      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181\n    \n    ports:\n      - \"8080:8080\"\n    \n    networks:\n      - stacklens-network\n    \n    restart: on-failure\n\nnetworks:\n  stacklens-network:\n    driver: bridge\n\nvolumes:\n  postgres-analytics-data:\n    driver: local\n  kafka-analytics-data:\n    driver: local\n  zookeeper-analytics-data:\n    driver: local\n