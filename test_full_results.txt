
> stacklens-ai-platform@1.0.0 pretest
> node scripts/generate-test-token.js

‚úÖ Token is valid
‚è∞ Expires in 2 days (2025-11-28T18:00:41.000Z)

> stacklens-ai-platform@1.0.0 test
> playwright test

[dotenv@17.2.3] injecting env (14) from .env -- tip: ‚úÖ audit secrets and track compliance: https://dotenvx.com/ops
[2m[WebServer] [22m
[2m[WebServer] [22m> stacklens-ai-platform@1.0.0 test:server /Users/deepak/Downloads/Projects/StackLens-AI-Deploy
[2m[WebServer] [22m> cross-env NODE_ENV=test node --import tsx --no-warnings apps/api/src/index.ts
[2m[WebServer] [22m
[2m[WebServer] [22m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  load multiple .env files with { path: ['.env.local', '.env'] }
[2m[WebServer] [22mü§ñ AI Service initialized with 1 providers: gemini
[2m[WebServer] [22m[dotenv@17.2.3] injecting env (0) from .env -- tip: üë• sync secrets across teammates & machines: https://dotenvx.com/ops
[2m[WebServer] [22m[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  suppress all logs with { quiet: true }
[2m[WebServer] [22müöÄ RAG: Vector database initialized
[2m[WebServer] [22m{"level":"WARN","timestamp":"2025-11-26T03:23:57.221Z","logger":"kafkajs","message":"KafkaJS v2.0.0 switched default partitioner. To retain the same partitioning behavior as in previous versions, create the producer with the option \"createPartitioner: Partitioners.LegacyPartitioner\". See the migration guide at https://kafka.js.org/docs/migration-guide-v2.0.0#producer-new-default-partitioner for details. Silence this warning by setting the environment variable \"KAFKAJS_NO_PARTITIONER_WARNING=1\""}
[2m[WebServer] [22mSetting up SQLite database...
[2m[WebServer] [22m‚úÖ SQLite database initialized successfully
[2m[WebServer] [22müîÑ Starting server initialization...
[2m[WebServer] [22m‚úÖ Database tables initialized
[2m[WebServer] [22mStarting LogWatcher service for real-time monitoring...
[2m[WebServer] [22müìç Watching directories: /Users/deepak/Downloads/Projects/StackLens-AI-Deploy/data, /Users/deepak/Downloads/Projects/StackLens-AI-Deploy/logs
[2m[WebServer] [22m[LogWatcherService] Started watching 2 file(s)
[2m[WebServer] [22m‚úÖ LogWatcher service started successfully
[2m[WebServer] [22m‚úÖ Routes registered successfully
[2m[WebServer] [22müìö RAG: Indexing 50 resolved error patterns...
[2m[WebServer] [22m‚úÖ RAG: Knowledge base populated with 50 patterns
[2m[WebServer] [22m8:54:00 AM [express] serving on port 4001
[2m[WebServer] [22müîÑ Indexing existing errors for RAG system...
[2m[WebServer] [22m‚ÑπÔ∏è No errors with suggestions found for indexing
[2m[WebServer] [22m‚úÖ Enhanced RAG Suggestor initialized
[2m[WebServer] [22müéØ Enhanced RAG system ready with vector database
[2m[WebServer] [22müöÄ Starting Python vector database service...
[2m[WebServer] [22m‚úÖ Vector database service initialized
[2m[WebServer] [22m‚ö†Ô∏è Enhanced vector service not found, using fallback similarity search

Running 417 tests using 5 workers

[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  override existing env vars with { override: true }
[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
Starting authentication setup...
‚úì Auth state file verified
  ‚úì    2 [setup] ‚Ä∫ tests/auth.setup.ts:135:1 ‚Ä∫ verify auth state (851ms)
Using TEST_FIREBASE_TOKEN for authentication...
[2m[WebServer] [22m[DEBUG] verifyFirebaseToken called with token: 'eyJhbGciOiJSUzI1NiIsImtpZCI6Im1vY2sta2V5LWlkIiwidHlwIjoiSldUIn0.eyJpc3MiOiJodHRwczovL3NlY3VyZXRva2VuLmdvb2dsZS5jb20vZXJyb3ItYW5hbHlzaXMtZjQ2YzYiLCJhdWQiOiJlcnJvci1hbmFseXNpcy1mNDZjNiIsImF1dGhfdGltZSI6MTc2Mzc0ODA0MSwidXNlcl9pZCI6InRlc3QtdXNlci0wMDEiLCJzdWIiOiJ0ZXN0LXVzZXItMDAxIiwiaWF0IjoxNzYzNzQ4MDQxLCJleHAiOjE3NjQzNTI4NDEsImVtYWlsIjoidGVzdEBzdGFja2xlbnMuYWkiLCJlbWFpbF92ZXJpZmllZCI6ZmFsc2UsImZpcmViYXNlIjp7ImlkZW50aXRpZXMiOnsiZW1haWwiOlsidGVzdEBzdGFja2xlbnMuYWkiXX0sInNpZ25faW5fcHJvdmlkZXIiOiJwYXNzd29yZCJ9fQ.zVrPuGwTDrdpm9uPxx7HyDV1Zwex6AuWdc3HhojgdlQ'
[2m[WebServer] [22m[DEBUG] NODE_ENV: 'test'
[2m[WebServer] [22m‚ö†Ô∏è Token verification failed - likely expired. Attempting to decode without verification for development mode...
[2m[WebServer] [22müëë Granting admin role to test@stacklens.ai
[2m[WebServer] [22m8:54:08 AM [express] POST /api/auth/firebase-signin 200 in 303ms :: {"user":{"id":1,"username":"Test‚Ä¶
‚úì Token exchange successful
[2m[WebServer] [22m8:54:09 AM [express] GET /api/auth/me 200 in 1ms :: {"id":1,"email":"test@stacklens.ai","username":"‚Ä¶
[2m[WebServer] [22m8:54:10 AM [express] GET /api/admin/ui-settings 200 in 14ms :: {"theme":"light","sidebarCollapsed":f‚Ä¶
[2m[WebServer] [22m8:54:10 AM [express] GET /api/admin/api-settings 200 in 8ms :: {"geminiApiKey":"AIzaSyAOu2YCkjimtYsv‚Ä¶
‚úì Authentication successful with session token
‚úì Authentication state saved to /Users/deepak/Downloads/Projects/StackLens-AI-Deploy/tests/.auth/user.json
  ‚úì    1 [setup] ‚Ä∫ tests/auth.setup.ts:15:1 ‚Ä∫ authenticate user (5.1s)
[dotenv@17.2.3] injecting env (0) from .env -- tip: üîÑ add secrets lifecycle management: https://dotenvx.com/ops
[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  write to custom object with { processEnv: myObject }
[dotenv@17.2.3] injecting env (0) from .env -- tip: üõ†Ô∏è  run anywhere with `dotenvx run -- yourcommand`
[dotenv@17.2.3] injecting env (0) from .env -- tip: ‚öôÔ∏è  specify custom .env file path with { path: '/custom/path/.env' }
[2m[WebServer] [22m[DEBUG] verifyFirebaseToken called with token: 'valid-test-token'
[2m[WebServer] [22m[DEBUG] NODE_ENV: 'test'
[2m[WebServer] [22müëë Granting admin role to test@stacklens.ai
[2m[WebServer] [22m8:54:14 AM [express] POST /api/auth/firebase-verify 200 in 15ms :: {"valid":true,"user":{"id":1,"use‚Ä¶
[2m[WebServer] [22m[DEBUG] verifyFirebaseToken called with token: 'valid-test-token'
[2m[WebServer] [22m[DEBUG] NODE_ENV: 'test'
[2m[WebServer] [22müëë Granting admin role to test@stacklens.ai
[dotenv@17.2.3] injecting env (0) from .env -- tip: üîê prevent building .env in docker: https://dotenvx.com/prebuild
[2m[WebServer] [22m8:54:14 AM [express] POST /api/auth/firebase-signin 200 in 4ms :: {"user":{"id":1,"username":"Test U‚Ä¶
[2m[WebServer] [22m8:54:14 AM [express] GET /api/auth/me 200 in 1ms :: {"id":1,"email":"test@stacklens.ai","username":"‚Ä¶
  ‚úì    5 [api-tests] ‚Ä∫ tests/api/auth-upload.test.ts:27:5 ‚Ä∫ Authentication API ‚Ä∫ POST /api/auth/firebase-verify - should verify token (303ms)
  ‚úì    4 [api-tests] ‚Ä∫ tests/api/auth-upload.test.ts:42:5 ‚Ä∫ Authentication API ‚Ä∫ GET /api/auth/me - should return current user (360ms)
  ‚úì    3 [api-tests] ‚Ä∫ tests/api/auth-upload.test.ts:11:5 ‚Ä∫ Authentication API ‚Ä∫ POST /api/auth/firebase-signin - should authenticate user (325ms)
[2m[WebServer] [22mSkipping body parsing for: /api/upload
[2m[WebServer] [22m8:54:14 AM [express] GET /api/auth/me 401 in 0ms :: {"message":"Authentication required"}
[2m[WebServer] [22mPOST /api/upload hit
[2m[WebServer] [22mreq.file: {
[2m[WebServer] [22m  fieldname: [32m'file'[39m,
[2m[WebServer] [22m  originalname: [32m'test-errors.xlsx'[39m,
[2m[WebServer] [22m  encoding: [32m'7bit'[39m,
[2m[WebServer] [22m  mimetype: [32m'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'[39m,
[2m[WebServer] [22m  destination: [32m'test-uploads/'[39m,
[2m[WebServer] [22m  filename: [32m'file-1764127454617-80059032.xlsx'[39m,
[2m[WebServer] [22m  path: [32m'test-uploads/file-1764127454617-80059032.xlsx'[39m,
[2m[WebServer] [22m  size: [33m9[39m
[2m[WebServer] [22m}
[2m[WebServer] [22mreq.user: {
[2m[WebServer] [22m  id: [33m1[39m,
[2m[WebServer] [22m  email: [32m'test@stacklens.ai'[39m,
[2m[WebServer] [22m  username: [32m'testuser'[39m,
[2m[WebServer] [22m  role: [32m'admin'[39m
[2m[WebServer] [22m}
