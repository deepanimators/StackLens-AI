#!/usr/bin/env python3\n\"\"\"\nUser Service Mock - External Service for User Profile Enrichment\n\nSimulates an external user service API that enrichment service calls for\nuser profile lookups. In production, this would be a real user service.\n\nEndpoints:\n  GET /health - Health check\n  GET /api/users/{user_id} - Get user profile\n  POST /api/users/batch - Get multiple user profiles\n\nRun with:\n    python user_service_mock.py\n\"\"\"\n\nimport os\nimport json\nimport logging\nimport random\nfrom datetime import datetime, timedelta\nfrom flask import Flask, jsonify, request\n\n# Configuration\nSERVICE_PORT = int(os.getenv('SERVICE_PORT', '8002'))\nSERVICE_HOST = os.getenv('SERVICE_HOST', '0.0.0.0')\nLOG_LEVEL = os.getenv('LOG_LEVEL', 'INFO')\n\n# Logging\nlogging.basicConfig(\n    level=getattr(logging, LOG_LEVEL),\n    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s'\n)\nlogger = logging.getLogger(__name__)\n\napp = Flask(__name__)\n\n# Mock user database\nMOCK_USERS = {\n    'user-123': {\n        'user_id': 'user-123',\n        'username': 'john.doe',\n        'email': 'john@example.com',\n        'country': 'US',\n        'account_age_days': 365,\n        'subscription_tier': 'premium',\n        'is_premium': True,\n        'company': 'Acme Corp',\n        'department': 'Engineering',\n    },\n    'user-456': {\n        'user_id': 'user-456',\n        'username': 'jane.smith',\n        'email': 'jane@example.com',\n        'country': 'UK',\n        'account_age_days': 180,\n        'subscription_tier': 'basic',\n        'is_premium': False,\n        'company': 'Tech Ltd',\n        'department': 'Sales',\n    },\n    'user-789': {\n        'user_id': 'user-789',\n        'username': 'bob.wilson',\n        'email': 'bob@example.com',\n        'country': 'CA',\n        'account_age_days': 730,\n        'subscription_tier': 'enterprise',\n        'is_premium': True,\n        'company': 'Global Corp',\n        'department': 'Executive',\n    },\n}\n\n# Statistics\nstats = {\n    'total_requests': 0,\n    'successful_lookups': 0,\n    'failed_lookups': 0,\n    'batch_requests': 0,\n}\n\n\n@app.route('/health', methods=['GET'])\ndef health():\n    \"\"\"Health check endpoint\"\"\"\n    return jsonify({\n        'status': 'healthy',\n        'service': 'user-service-mock',\n        'timestamp': datetime.utcnow().isoformat(),\n    }), 200\n\n\n@app.route('/api/users/<user_id>', methods=['GET'])\ndef get_user(user_id):\n    \"\"\"Get user profile by ID\"\"\"\n    stats['total_requests'] += 1\n    \n    logger.debug(f\"Looking up user: {user_id}\")\n    \n    # Check if user exists\n    if user_id in MOCK_USERS:\n        stats['successful_lookups'] += 1\n        user = MOCK_USERS[user_id]\n        \n        logger.info(f\"User found: {user_id}\")\n        return jsonify({\n            'success': True,\n            'data': user,\n            'retrieved_at': datetime.utcnow().isoformat(),\n        }), 200\n    else:\n        stats['failed_lookups'] += 1\n        logger.warning(f\"User not found: {user_id}\")\n        return jsonify({\n            'success': False,\n            'error': 'User not found',\n            'user_id': user_id,\n        }), 404\n\n\n@app.route('/api/users/batch', methods=['POST'])\ndef get_users_batch():\n    \"\"\"Get multiple user profiles\"\"\"\n    stats['batch_requests'] += 1\n    data = request.get_json()\n    user_ids = data.get('user_ids', [])\n    \n    logger.debug(f\"Batch lookup for {len(user_ids)} users\")\n    \n    results = {}\n    for user_id in user_ids:\n        if user_id in MOCK_USERS:\n            results[user_id] = {\n                'success': True,\n                'data': MOCK_USERS[user_id],\n            }\n            stats['successful_lookups'] += 1\n        else:\n            results[user_id] = {\n                'success': False,\n                'error': 'User not found',\n            }\n            stats['failed_lookups'] += 1\n    \n    logger.info(f\"Batch lookup completed for {len(user_ids)} users\")\n    return jsonify({\n        'batch_size': len(user_ids),\n        'results': results,\n        'retrieved_at': datetime.utcnow().isoformat(),\n    }), 200\n\n\n@app.route('/api/stats', methods=['GET'])\ndef get_stats():\n    \"\"\"Get service statistics\"\"\"\n    total = stats['total_requests']\n    success_rate = (stats['successful_lookups'] / total * 100) if total > 0 else 0\n    \n    return jsonify({\n        'total_requests': total,\n        'successful_lookups': stats['successful_lookups'],\n        'failed_lookups': stats['failed_lookups'],\n        'batch_requests': stats['batch_requests'],\n        'success_rate': f\"{success_rate:.1f}%\",\n        'users_available': len(MOCK_USERS),\n    }), 200\n\n\n@app.errorhandler(500)\ndef internal_error(error):\n    \"\"\"Handle internal server errors\"\"\"\n    logger.error(f\"Internal server error: {error}\")\n    return jsonify({\n        'success': False,\n        'error': 'Internal server error',\n    }), 500\n\n\nif __name__ == '__main__':\n    logger.info(f\"Starting User Service Mock on {SERVICE_HOST}:{SERVICE_PORT}\")\n    logger.info(f\"Available mock users: {', '.join(MOCK_USERS.keys())}\")\n    app.run(\n        host=SERVICE_HOST,\n        port=SERVICE_PORT,\n        debug=LOG_LEVEL == 'DEBUG',\n        threaded=True,\n    )\n