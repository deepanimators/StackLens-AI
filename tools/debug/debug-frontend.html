<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Debug Frontend Issues</title>
  </head>
  <body>
    <h1>Frontend Debug Tool</h1>
    <button onclick="testExport()">Test Export</button>
    <button onclick="testDataStructure()">Test Data Structure</button>
    <div id="debug-info"></div>
    <div id="test-results"></div>

    <script>
      const debugInfo = document.getElementById("debug-info");
      const testResults = document.getElementById("test-results");

      // Function to log debug info
      function log(message, type = "info") {
        const div = document.createElement("div");
        div.style.margin = "5px 0";
        div.style.color =
          type === "error" ? "red" : type === "success" ? "green" : "black";
        div.textContent = `[${type.toUpperCase()}] ${message}`;
        debugInfo.appendChild(div);
      }

      // Check localStorage
      log("Checking localStorage...");
      const token = localStorage.getItem("token");
      const authToken = localStorage.getItem("auth_token");
      const user = localStorage.getItem("user");

      if (token) {
        log(`Token found (token key): ${token.substring(0, 20)}...`, "success");
      } else {
        log("No token found in localStorage (token key)", "error");
      }

      if (authToken) {
        log(
          `Auth token found (auth_token key): ${authToken.substring(0, 20)}...`,
          "success"
        );
      } else {
        log("No auth_token found in localStorage", "error");
      }

      if (user) {
        log(`User data found: ${user}`, "success");
      } else {
        log("No user data found in localStorage", "error");
      }

      // Test export functionality
      async function testExport() {
        log("Testing export functionality...");

        const testToken = authToken || token;
        if (!testToken) {
          log("No token available for testing export", "error");
          return;
        }

        try {
          const response = await fetch("/api/export/errors?analysisId=41", {
            method: "GET",
            headers: {
              Authorization: `Bearer ${testToken}`,
              "Content-Type": "application/json",
            },
          });

          if (response.ok) {
            log(
              `Export test successful! Status: ${response.status}`,
              "success"
            );
            log(
              `Content-Type: ${response.headers.get("Content-Type")}`,
              "success"
            );
          } else {
            log(
              `Export test failed! Status: ${response.status} - ${response.statusText}`,
              "error"
            );
            const text = await response.text();
            log(`Response: ${text}`, "error");
          }
        } catch (error) {
          log(`Export test error: ${error.message}`, "error");
        }
      }

      // Test the actual data structure
      async function testDataStructure() {
        log("Testing error data structure...");

        try {
          // Test file 13 errors which we know have suggestions
          const testToken = authToken || token;
          const response = await fetch("/api/files/13/errors?limit=3", {
            headers: {
              Authorization: `Bearer ${testToken}`,
            },
          });

          if (response.ok) {
            const data = await response.json();
            log(`Found ${data.errors.length} errors in file 13`, "success");

            data.errors.forEach((error, index) => {
              log(`Error ${index + 1}: ID=${error.id}`, "info");
              log(
                `  - Has aiSuggestion: ${error.aiSuggestion ? "YES" : "NO"}`,
                error.aiSuggestion ? "success" : "error"
              );
              if (error.aiSuggestion) {
                log(
                  `  - Root cause: ${
                    error.aiSuggestion.rootCause || "Not specified"
                  }`,
                  "info"
                );
                log(
                  `  - Resolution steps: ${
                    error.aiSuggestion.resolutionSteps
                      ? error.aiSuggestion.resolutionSteps.length
                      : 0
                  }`,
                  "info"
                );
              }
            });
          } else {
            log(`File errors API failed: ${response.status}`, "error");
          }

          // Also test the main errors API
          const mainResponse = await fetch("/api/errors?limit=3", {
            headers: { Authorization: `Bearer ${token}` },
          });

          if (mainResponse.ok) {
            const mainData = await mainResponse.json();
            log(`Main errors API: ${mainData.errors.length} errors`, "success");

            mainData.errors.forEach((error, index) => {
              log(`Main Error ${index + 1}: ID=${error.id}`, "info");
              log(
                `  - Has aiSuggestion: ${error.aiSuggestion ? "YES" : "NO"}`,
                error.aiSuggestion ? "success" : "error"
              );
            });
          } else {
            log(`Main errors API failed: ${mainResponse.status}`, "error");
          }
        } catch (error) {
          log(`Data structure test error: ${error.message}`, "error");
        }
      }

      // Test API endpoints
      async function testAPI() {
        log("Testing API endpoints...");

        const headers = {
          "Content-Type": "application/json",
        };

        if (token) {
          headers["Authorization"] = `Bearer ${token}`;
        }

        try {
          // Test patterns endpoint
          log("Testing patterns API...");
          const patternsResponse = await fetch("/api/files/13/patterns", {
            method: "GET",
            headers,
          });

          if (patternsResponse.ok) {
            const patternsData = await patternsResponse.json();
            log(
              `Patterns API successful: ${patternsData.patterns.length} patterns found`,
              "success"
            );
          } else {
            log(
              `Patterns API failed: ${patternsResponse.status} ${patternsResponse.statusText}`,
              "error"
            );
          }

          // Test suggestions endpoint
          log("Testing suggestions API...");
          const suggestionsResponse = await fetch(
            "/api/errors/2647/suggestion",
            {
              method: "POST",
              headers,
            }
          );

          if (suggestionsResponse.ok) {
            const suggestionsData = await suggestionsResponse.json();
            log(
              `Suggestions API successful: ${
                suggestionsData.suggestion
                  ? "Suggestion found"
                  : "No suggestion"
              }`,
              "success"
            );
          } else {
            log(
              `Suggestions API failed: ${suggestionsResponse.status} ${suggestionsResponse.statusText}`,
              "error"
            );
          }

          // Test errors endpoint
          log("Testing errors API...");
          const errorsResponse = await fetch("/api/errors", {
            method: "GET",
            headers,
          });

          if (errorsResponse.ok) {
            const errorsData = await errorsResponse.json();
            log(
              `Errors API successful: ${
                errorsData.errors ? errorsData.errors.length : 0
              } errors found`,
              "success"
            );
          } else {
            log(
              `Errors API failed: ${errorsResponse.status} ${errorsResponse.statusText}`,
              "error"
            );
          }
        } catch (error) {
          log(`API test error: ${error.message}`, "error");
        }
      }

      // Run tests after page loads
      window.addEventListener("load", () => {
        if (token) {
          setTimeout(() => {
            testAPI();
            testDataStructure();
          }, 1000);
        }
      });

      // Check if we need to login first
      if (!token) {
        log("Attempting to login first...");

        fetch("/api/auth/login", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            username: "deepanimators",
            password: "admin123",
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.token) {
              localStorage.setItem("token", data.token);
              localStorage.setItem("user", JSON.stringify(data.user));
              log("Login successful, token stored", "success");
              location.reload();
            } else {
              log("Login failed", "error");
            }
          })
          .catch((error) => {
            log(`Login error: ${error.message}`, "error");
          });
      }
    </script>
  </body>
</html>
